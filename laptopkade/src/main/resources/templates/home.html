<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Laptop Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
        <script src="https://unpkg.com/htmx.org"></script>
</head>
<body>
<div class="container py-5">
    <div class="header-card">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
            <div>
                <h1>Welcome to Laptop Store <span class="ribbon">Fresh picks</span></h1>
                <p class="mb-0">Browse curated laptops with images, specs and prices ‚Äî designed to be simple and friendly.</p>
                <div class="search-row">
                        <input class="form-control" 
                               id="searchInput"
                               type="text" 
                               placeholder="Search laptops, brands..." 
                               aria-label="search"
                               hx-get="/search"
                               hx-trigger="keyup changed delay:500ms"
                               hx-target="#laptop-list"
                               hx-swap="innerHTML"
                               hx-include="[name='query']">
                        <button class="btn btn-light" 
                                type="button"
                                hx-get="/search" 
                                hx-target="#laptop-list"
                                hx-include="[name='query']"
                                hx-swap="innerHTML">Search</button>
                        <input type="hidden" name="query" id="queryInput" value="">
                </div>
            </div>
            <div class="mt-3 mt-md-0 text-md-end">
                <small class="d-block">Open now</small>
                <small class="d-block">Free shipping over $500</small>
                <!-- Cart / Checkout button visible to all users -->
                <div class="d-inline-block mb-2">
                    <a class="btn btn-outline-light btn-sm me-2" th:href="@{/cart}">
                        üõí Cart
                        <span class="badge bg-light text-dark ms-2" th:text="${session.cart != null ? #maps.size(session.cart) : 0}">0</span>
                    </a>
                </div>
                <div sec:authorize="hasRole('ADMIN')">
                    <a class="btn btn-outline-light btn-sm mt-2" th:href="@{/laptops/new}">+ Add Laptop</a>
                    <small class="d-block text-white mt-2" style="opacity: 0.9;">
                        <a th:href="@{/logout}" style="color: white; text-decoration: none;">üîë Admin Logout</a>
                    </small>
                </div>
                <div sec:authorize="!hasRole('ADMIN')">
                    <a class="btn btn-outline-light btn-sm mt-2" th:href="@{/login}">üîê Admin Login</a>
                </div>
                <!-- Customer Auth Section -->
                <div th:if="${session.loggedInUser != null}" class="mt-3">
                    <small class="d-block text-white" style="opacity: 0.9;">Welcome, <strong th:text="${session.loggedInUser.username}">User</strong></small>
                    <a class="btn btn-outline-light btn-sm mt-2" th:href="@{/user-logout}">üë§ Logout</a>
                </div>
                <div th:if="${session.loggedInUser == null}" class="mt-3">
                    <a class="btn btn-outline-light btn-sm" th:href="@{/user-login}">üë§ Login</a>
                    <a class="btn btn-outline-light btn-sm ms-2" th:href="@{/register}">üìù Register</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
                <div id="laptop-list" class="list-wrapper">
                <div th:each="laptop : ${laptops}" class="item-card">
                    <img th:src="@{${laptop.imageUrl}}" alt="Laptop Image">
                    <div class="item-content">
                        <h5 th:text="${laptop.name}">Laptop Name</h5>
                        <p class="mb-1" th:text="${laptop.brand}">Brand</p>
                    </div>
                    <div style="min-width:140px; text-align:right;">
                        <div class="price" th:text="${laptop.price}">$0</div>
                        <form th:action="@{/cart/add}" method="post" style="margin-top:8px;">
                            <input type="hidden" name="laptopId" th:value="${laptop.id}" />
                            <input type="hidden" name="quantity" value="1" />
                            <button type="submit" class="btn btn-sm btn-primary">Add to Cart</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="footer-note">Showing <span id="count" th:text="${#lists.size(laptops)}">0</span> laptops</div>
        </div>
    </div>

</div>

<script>
    // Update hidden query input when user types in search box
    document.getElementById('searchInput').addEventListener('input', function(e) {
        document.getElementById('queryInput').value = e.target.value;
    });
    
    // Update count when HTMX loads new results
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'laptop-list') {
            const count = document.querySelectorAll('#laptop-list .item-card').length;
            document.getElementById('count').textContent = count;
        }
    });
</script>
</body>
</html>
